name: Auto Create Main Merge Request

on:
  pull_request:
    types: [closed]
    branches:
      - development  # Chạy khi PR được merge vào development

jobs:
  create_merge_request:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: development  # Checkout development branch

      - name: Install GitHub CLI
        run: |
          sudo apt update && sudo apt install gh -y

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token

      - name: Create Merge Request to Main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Lấy thông tin PR đã merge
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Kiểm tra xem PR từ development vào main đã tồn tại chưa
          existing_pr=$(gh pr list --base main --head development --json number -q '.[0].number')

          if [ -z "$existing_pr" ]; then
            # Tạo PR mới
            gh pr create \
              --base main \
              --head development \
              --title "[Auto] Merge development into main" \
              --body "## Automatic merge request to main
              
              This PR was automatically created after merging '$SOURCE_BRANCH' into development.
              
              **Original PR title**: $PR_TITLE  
              **Original PR**: #$PR_NUMBER  
              
              Please review the changes before merging into main."

            # Lấy số PR vừa tạo
            pr_number=$(gh pr list --base main --head development --json number -q '.[0].number')

            # Kiểm tra xem nhãn "Auto-Merge" có tồn tại không, nếu không thì tạo
            if ! gh label list | grep -q "Auto-Merge"; then
              gh label create "Auto-Merge" --description "Automatically merged PRs" --color "#0E8A16"
            fi

            # Gán nhãn "Auto-Merge" cho PR
            gh pr edit "$pr_number" --add-label "Auto-Merge"

            echo "✅ Created PR #$pr_number"
          else
            echo "⚠️ A pull request from development to main already exists (#$existing_pr)"
          fi

