name: Auto Create Main Merge Request

on:
  pull_request:
    types: [closed]
    branches:
      - development  # Ch·∫°y khi PR ƒë∆∞·ª£c merge v√†o development

jobs:
  create_merge_request:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout development branch
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          ref: development  # ƒê·∫£m b·∫£o checkout branch development

      - name: Install GitHub CLI
        run: |
          sudo apt update && sudo apt install gh -y

      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if [[ -z "$GITHUB_TOKEN" ]]; then
            echo "‚ùå PAT_TOKEN is missing. Make sure to add it in GitHub Secrets."
            exit 1
          fi
          
          echo "$GITHUB_TOKEN" | gh auth login --with-token
          gh auth status || exit 1  # Ki·ªÉm tra x√°c th·ª±c

      - name: Create Merge Request to Main
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # L·∫•y th√¥ng tin PR ƒë√£ merge
          SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "‚úÖ Source branch: $SOURCE_BRANCH"
          echo "‚úÖ PR Title: $PR_TITLE"
          echo "‚úÖ PR Number: $PR_NUMBER"

          # Ki·ªÉm tra xem PR t·ª´ development v√†o main ƒë√£ t·ªìn t·∫°i ch∆∞a
          existing_pr=$(gh pr list --base main --head development --json number -q '.[0].number')

          if [ -z "$existing_pr" ]; then
            echo "üöÄ Creating new PR from development to main..."

            gh pr create \
              --base main \
              --head development \
              --title "[Auto] Merge development into main" \
              --body "## Automatic merge request to main
              
              This PR was automatically created after merging '$SOURCE_BRANCH' into development.
              
              **Original PR title**: $PR_TITLE  
              **Original PR**: #$PR_NUMBER  
              
              Please review the changes before merging into main."

            # L·∫•y s·ªë PR v·ª´a t·∫°o
            pr_number=$(gh pr list --base main --head development --json number -q '.[0].number')

            if [ -n "$pr_number" ]; then
              echo "‚úÖ PR #$pr_number created successfully."

              # Ki·ªÉm tra xem nh√£n "Auto-Merge" c√≥ t·ªìn t·∫°i kh√¥ng, n·∫øu kh√¥ng th√¨ t·∫°o
              if ! gh label list | grep -q "Auto-Merge"; then
                gh label create "Auto-Merge" --description "Automatically merged PRs" --color "#0E8A16"
              fi

              # G√°n nh√£n "Auto-Merge" cho PR
              gh pr edit "$pr_number" --add-label "Auto-Merge"
              echo "‚úÖ Added label 'Auto-Merge' to PR #$pr_number

